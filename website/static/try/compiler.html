<html>

<head>
<script type="text/javascript" lang="javascript" src="/fx/flapjax.js">
</script>
<script type="text/javascript" src="/demos/prototype.js"></script>
<script type="text/javascript">
function makeUpload(src) {
  return {
    url: '/fxserver/setobj/tryFlapjax/',
    body: src,
    request: 'rawPost',
    response: 'json', /* we get back a simple true/false value */
    asynchronous: true /* this is how we roll */
  };
};

function makeCompileRequest(src) {
  return {
    url: "/fxserver/compile/",
    body: src,
    request: "rawPost",
    response: "plain", // TODO: be more informative
    asynchronous: true }};

function makeDownload(src) {
  return function(_) {
    return {
      url: '/demos/' + src,
      fields: { },
      request: 'rest',
      response: 'plain', /* don't interpret the result--it's source code */
      asynchronous: true
    };
  };
};

function whenTrue(v) { return v === true; };

function loadInitial(onLoadE) {
  // For the edit in the compiler feature of the demo page.
  var urlMatch = 
    window.parent.location.toString().match(/.*?\?edit\=(.*)$/);
  var editUrl = (urlMatch && urlMatch[1]) || 'mouse_coords.fx';

  var textE = getWebServiceObjectE(onLoadE.mapE(makeDownload(editUrl)));
  insertValueE(textE,$("usersrc"),"value"); }

function compileE(src) {
  return getWebServiceObjectE(clicksE($("compile")).snapshotE(src)
                              .mapE(makeCompileRequest)); }

function loader() {

  var src = $B('usersrc');

  compileE(src).mapE(function(compileResult) {
    window.parent.output.location.href = "/fxserver/getobj/tryFlapjax";
     });
  
  loadInitial(oneE(true)); }

document.observe("dom:loaded",loader);
</script>

</head>

<body>

<h1>Try Flapjax</h1>

<p>Enter your Flapjax code below.</p>

<p>
<a href="javascript:undefined" id="compile">Compile and Run</a>
</p>

<textarea id="usersrc" cols="80" rows="40">
Loading, please wait ...
</textarea>

</body>

</html>
