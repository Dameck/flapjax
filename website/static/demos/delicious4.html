<html>
<head>
<link rel="stylesheet" href="/demo.css"/>
<script type="text/javascript" src="/fx/flapjax.js"></script>
<script type="text/javascript" src="/fx/fxws.js"></script>


<title>Flapjax Demo: Delicious bookmarks with a history</title>

<script type="text/javascript">

// This function is from the previous demo.
function collapsedItems_b(linksE,maxLength) {
  
  var collapsedItem_b = function(post) {
    var full = post.d;
    var url = post.u;
    
    var collapsed = (full.length <= maxLength) 
      ? full : (full.substr(0,maxLength) + '...');
      
    return tagRec(['mouseover', 'mouseout'],
      function (overE,outE) {
        return LIB(AB({ href: url },
          merge_e(overE.constant_e(full),outE.constant_e(collapsed))
          .hold(collapsed)));
      });
  };
  
  return linksE.lift_e(function(links) {
    return map(collapsedItem_b,links.posts);
  })
  .hold([ ])
  .lift_b(function (items) {
      return items.length == 0 ? 'Type to start' : ULB(items);
  })
  .switch_b();
};

var history_e = function(nextE) {
  
  var historyE = nextE.collect_e([],function(item,arr) {
    arr.push(item); arr.slice(0,10); return arr;
  });
  
  var linksE = historyE.lift_e(function(items) {
    return map(function(item) {
      var a = A({ href: 'javascript:undefined' },item);
      return { 
        anchor: SPAN({ style: { padding: '5px' }},a),
        click: clicks_e(a).constant_e(item) };
    }, items);
  });
  
  
  var controlB = linksE.lift_e(function(items) {
      return map(function(item) { return item.anchor; },items);
    })
    .hold('No requests yet.')
    .lift_b(function (anchors) { return DIVB(anchors); })
    .switch_b();
  
  var oldE = linksE.lift_e(function(items) {
      return merge_e.apply(this,
        map(function(item) { return item.click; }, items));
    })
    .switch_e();
  
  return { 
    controlB: controlB,
    nextE: merge_e(nextE,oldE)
  };
}

function loader() {
  
	var requestsE = extractValue_e('userName')
    .filter_e(function (str) { return str.length > 0; })
    .calm_e(450);
  
  var history = history_e(requestsE); 
  
  var linksInfoE = evalForeignScriptVal_e(history.nextE
    .calm_e(450).lift_e(function (name) {
      return { 
        'url': 'http://del.icio.us/feeds/json/' + name,
        'globalArg': 'Delicious'
      };
    }));
  
  insertDomB(collapsedItems_b(linksInfoE,20),'userLinks');
  insertDomB(history.controlB,'history');
  
}

</script>
</head>
<body onload="loader();">

<div style="text-align: center">

<span style="padding: 2px">
<a id="mylink" href="http://del.icio.us">del.icio.us</a>
</span> 

user name: <input type="text" id="userName"/><br/><br/>

<span id="history">request history</span>
<ul id="userLinks">delicious user links go here</ul>

</div>

</body>
</html>
