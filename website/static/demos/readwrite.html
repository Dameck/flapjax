<html>
<head>


<link rel="stylesheet" href="/demo.css"/>
<script type="text/javascript" src="/fx/flapjax.js"></script>


<title>Flapjax: Reading and Writing</title>
<script type="text/javascript">

function readFrom(objName,val) {
  return function(_) { // discard what is usually a timer value
    return {
      url: '/fxserver/getobj/' + objName + '/',
      fields: { name: objName, "default": val },
      request: 'post',
      response: 'plain', // do not parse the response
      asynchronous: true
    };
  };
};

function writeTo(name,valE) {
  return valE.mapE(function(val) {
      return {
        url: '/fxserver/setobj/' + name + '/',
        fields: { name: name, value: val },
        request: 'post',
        response: 'json', // parse the response as a JSON value (it's simply 'true')
        asynchronous: true
      };
  });
};

function loader() {
  // Poll the server for 'someValue' every two seconds.
  var someValue = getWebServiceObjectE(timerE(2000).mapE(readFrom('someValue',"nothing saved")));
  // Create a text node in the DOM with the contents of someValue
  insertDomE(someValue,$('someValue'));
  // Send a request to the server when the value changes.  'Calm' the requests so that we don't send more than once
  // every second.
  getWebServiceObjectE(writeTo('someValue',extractValueE('someValueSrc','value').calmE(1000)));
  
}    

/*
initFlapjaxServerAPIs(getFlapjaxObj(), 'http://www.flapjax-lang.org/flapjax/servlets/');

writePersistentObject(extractValueB('someValue').changes(), { path: ['someValue'] });
writePersistentObject(extractValueB('someArr0').transform(function (val) { return [val]; }).changes(), 
{ path: ['someArr'] });
writePersistentObject(extractValueB('someObjbar').transform(function (val) { return { bar: val }; }).changes(),
{ path: ['someObj'] });


var someValue = readPersistentObject({initial: '', path: ['someValue'], poll: 1800 });
var someArr = readPersistentObject({initial: [''], path: ['someArr'], poll: 1800 });
var someObj = readPersistentObject({initial: {bar:''}, path: ['someObj'], poll: 1800 });*/

</script>
</head>

<body onload="javascript:loader()">
<h1>Readers</h1>
<p>someValue: <div id="someValue"><i>Waiting for server ...</i></div></p>
<div>someValue: {! someValue !}</div>
<div>someArr[0]: {! someArr[0] !}</div>
<div>someObj.bar: {! someObj.bar !}</div>
<h1>Writers</h1>
<p>someValue: <input type="text" id="someValueSrc" /></p>

</body>
</html>
